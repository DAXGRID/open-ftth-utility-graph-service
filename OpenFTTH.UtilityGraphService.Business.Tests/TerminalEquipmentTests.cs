using Microsoft.Extensions.Logging;
using OpenFTTH.Events.RouteNetwork;
using OpenFTTH.UtilityGraphService.Model.UtilityNetwork.Events;
using OpenFTTH.UtilityGraphService.Query.InMemory;
using System;
using System.Collections.Generic;
using System.Linq;
using Xunit;

namespace OpenFTTH.UtilityGraphService.Business.Tests
{
    public class TerminalEquipmentTests
    {
        [Fact]
        public void CreateTerminalEquipment_InRouteNodeThatDontExists_ShouldThrowArgumentException()
        {
            ILoggerFactory loggerFactory = new Microsoft.Extensions.Logging.Abstractions.NullLoggerFactory();

            var networkState = new InMemoryNetworkState(loggerFactory);

            var queryApi = new InMemoryQueryHandler(loggerFactory, networkState);

            Assert.Throws<ArgumentException>(() => new TerminalEquipmentAggregate(queryApi, Guid.NewGuid(), Guid.NewGuid(), Guid.NewGuid()));
        }

        [Theory]
        [InlineData(
        @"
            [
            {""workTaskMrid"":""54800ae5-13a5-4b03-8626-a63b66a25568"",""userName"":""jespe"",""routeNetworkCommands"":[{""cmdType"":""NewRouteSegmentDigitized"",""cmdId"":""2622986e-9197-468e-b70f-be0ec9e2a9e9"",""routeNetworkEvents"":[{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""6be9abac-619a-42d4-8207-510a83d769cc"",""geometry"":""[557185.3754148477,6224206.351999512]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""02b93dfc-c15e-4639-a520-732ec1901c93"",""eventTimestamp"":""2020-10-28T10:40:31.3532228Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""6e229f7e-a704-41cd-b140-b66025f9c847"",""geometry"":""[557340.6768637084,6224231.927959681]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""a20bd448-311a-4dd8-bc02-d02bc68e7eb2"",""eventTimestamp"":""2020-10-28T10:40:31.3732172Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""153d2470-775a-4e85-b145-0fc5453c7cf2"",""fromNodeId"":""6be9abac-619a-42d4-8207-510a83d769cc"",""toNodeId"":""6e229f7e-a704-41cd-b140-b66025f9c847"",""geometry"":""[[557185.3754148477,6224206.351999512],[557242.5917381122,6224206.747504051],[557285.8335676761,6224206.483834358],[557318.0012701566,6224215.84410844],[557340.6768637084,6224231.927959681]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""727cd3b8-4141-4922-8a8e-8fbbf27837d0"",""eventTimestamp"":""2020-10-28T10:40:31.3740384Z"",""applicationName"":"""",""applicationInfo"":""""}]}],""eventSequenceNumber"":0,""eventType"":""RouteNetworkEditOperationOccuredEvent"",""eventId"":""cd80d94e-61f6-4470-95ea-215bf826a6be"",""eventTimestamp"":""2020-10-28T10:40:31.3853398Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""},
            {""workTaskMrid"":""54800ae5-13a5-4b03-8626-a63b66a25568"",""userName"":""jespe"",""routeNetworkCommands"":[{""cmdType"":""ExistingRouteSegmentSplitted"",""cmdId"":""705f5f3c-8317-477c-b4a9-c3d30b03f5bb"",""routeNetworkEvents"":[{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""362e1cbb-bf71-4b2b-bb8e-9d49ab09e54f"",""geometry"":""[557240.4106439104,6224206.732427362]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""025fa092-a16c-4e83-922f-e7b8ec4562c4"",""eventTimestamp"":""2020-10-28T10:40:56.5077753Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""c1334514-31d5-4eb6-98e4-bf942fcebaf3"",""fromNodeId"":""6be9abac-619a-42d4-8207-510a83d769cc"",""toNodeId"":""362e1cbb-bf71-4b2b-bb8e-9d49ab09e54f"",""geometry"":""[[557185.375414848,6224206.35199951],[557240.41064391,6224206.73242736]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""09674f13-dab4-4ccb-acbc-06b3995bf5f8"",""eventTimestamp"":""2020-10-28T10:40:56.5762619Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""c33e2460-596e-4c38-98f7-e128a17260a8"",""fromNodeId"":""362e1cbb-bf71-4b2b-bb8e-9d49ab09e54f"",""toNodeId"":""6e229f7e-a704-41cd-b140-b66025f9c847"",""geometry"":""[[557240.41064391,6224206.73242736],[557242.591738112,6224206.74750405],[557285.833567676,6224206.48383436],[557318.001270157,6224215.84410844],[557340.676863708,6224231.92795968]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""e98333ba-cdee-41b2-885f-64e7f6232c2f"",""eventTimestamp"":""2020-10-28T10:40:56.5810549Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentRemoved, OpenFTTH.Events"",""segmentId"":""153d2470-775a-4e85-b145-0fc5453c7cf2"",""replacedBySegments"":[""c1334514-31d5-4eb6-98e4-bf942fcebaf3"",""c33e2460-596e-4c38-98f7-e128a17260a8""],""eventSequenceNumber"":0,""eventType"":""RouteSegmentRemoved"",""eventId"":""c15ec018-0e14-44c1-b85a-1ce00bb5dca3"",""eventTimestamp"":""2020-10-28T10:40:56.5936973Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""}]},{""cmdType"":""NewRouteSegmentDigitized"",""cmdId"":""a2de7bdd-d311-45ac-82ad-b66211f6866f"",""routeNetworkEvents"":[{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""b3b5959d-0a12-4642-b0d3-96fa761735c1"",""geometry"":""[557240.1527934563,6224201.144523084]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""590a2fec-b46b-4d99-8d4c-db5acf8c6b58"",""eventTimestamp"":""2020-10-28T10:40:56.6097397Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""1e93b296-9742-4d1d-b526-f9f01e06370f"",""fromNodeId"":""362e1cbb-bf71-4b2b-bb8e-9d49ab09e54f"",""toNodeId"":""b3b5959d-0a12-4642-b0d3-96fa761735c1"",""geometry"":""[[557240.4106439104,6224206.732427362],[557240.1527934563,6224201.144523084]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""94b3a9c9-e08d-4089-ad5e-c269aaa4d730"",""eventTimestamp"":""2020-10-28T10:40:56.6099036Z"",""applicationName"":"""",""applicationInfo"":""""}]}],""eventSequenceNumber"":1,""eventType"":""RouteNetworkEditOperationOccuredEvent"",""eventId"":""4f519d9a-9163-4e97-a52c-d4f4a9007484"",""eventTimestamp"":""2020-10-28T10:40:56.6100308Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""},
            {""workTaskMrid"":""54800ae5-13a5-4b03-8626-a63b66a25568"",""userName"":""jespe"",""routeNetworkCommands"":[{""cmdType"":""NewRouteSegmentDigitized"",""cmdId"":""bb226adc-d742-4832-a7bf-09db017f2f97"",""routeNetworkEvents"":[{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""f485d95c-e32f-48c0-9c2b-6b2c9e7d75dd"",""geometry"":""[557245.8876092675,6224201.27635793]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""ba75afee-447f-4b8b-b1f2-78446d9342e6"",""eventTimestamp"":""2020-10-28T10:41:38.4672415Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""a66dfa07-ff11-4d57-bafd-94abb62b5dec"",""fromNodeId"":""b3b5959d-0a12-4642-b0d3-96fa761735c1"",""toNodeId"":""f485d95c-e32f-48c0-9c2b-6b2c9e7d75dd"",""geometry"":""[[557240.1527934563,6224201.144523084],[557245.8876092675,6224201.27635793]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""9be4033c-662b-4f1e-99e4-96300ef2ef34"",""eventTimestamp"":""2020-10-28T10:41:38.4679364Z"",""applicationName"":"""",""applicationInfo"":""""}]}],""eventSequenceNumber"":2,""eventType"":""RouteNetworkEditOperationOccuredEvent"",""eventId"":""6bbeecb9-f7ad-46d1-bd8c-ff62cd145e1d"",""eventTimestamp"":""2020-10-28T10:41:38.4680923Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""},
            {""workTaskMrid"":""54800ae5-13a5-4b03-8626-a63b66a25568"",""userName"":""jespe"",""routeNetworkCommands"":[{""cmdType"":""NewRouteSegmentDigitized"",""cmdId"":""0bc79460-6fad-49bc-9883-d3b0e7750a9e"",""routeNetworkEvents"":[{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""ab1d2406-a1c8-4e9c-8cc0-115f66fd800e"",""geometry"":""[557357.1562194884,6224139.709484739]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""63bf0dfb-c3f2-4c11-8482-d7aa3616f8ba"",""eventTimestamp"":""2020-10-28T10:41:38.5307305Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""0da073b5-3463-49ef-a122-5a78abda07d8"",""fromNodeId"":""b3b5959d-0a12-4642-b0d3-96fa761735c1"",""toNodeId"":""ab1d2406-a1c8-4e9c-8cc0-115f66fd800e"",""geometry"":""[[557240.1527934563,6224201.144523084],[557238.9003624171,6224185.5880112285],[557238.1093533396,6224147.224070975],[557241.5370593419,6224134.699760582],[557267.2448543573,6224134.699760582],[557357.1562194884,6224139.709484739]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""32b7b4bc-86e6-4d93-90f9-fb04f122fc86"",""eventTimestamp"":""2020-10-28T10:41:38.5310395Z"",""applicationName"":"""",""applicationInfo"":""""}]}],""eventSequenceNumber"":3,""eventType"":""RouteNetworkEditOperationOccuredEvent"",""eventId"":""792473c7-86fe-4fdb-ac4f-dd9eeec54808"",""eventTimestamp"":""2020-10-28T10:41:38.5312039Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""},
            {""workTaskMrid"":""54800ae5-13a5-4b03-8626-a63b66a25568"",""userName"":""jespe"",""routeNetworkCommands"":[{""cmdType"":""NewRouteSegmentDigitized"",""cmdId"":""d880c7fb-02c2-4ac3-8434-c490a6a99e4f"",""routeNetworkEvents"":[{""$type"":""OpenFTTH.Events.RouteNetwork.RouteNodeAdded, OpenFTTH.Events"",""nodeId"":""bafe3b26-dad1-43f9-8120-9c21c155bc43"",""geometry"":""[557186.0762978606,6224187.125002002]"",""routeNodeInfo"":null,""namingInfo"":null,""lifecyleInfo"":null,""mappingInfo"":null,""safetyInfo"":null,""eventSequenceNumber"":0,""eventType"":""RouteNodeAdded"",""eventId"":""a34fbf9e-9921-4117-adef-dd7245f36a3f"",""eventTimestamp"":""2020-10-28T10:44:43.5162069Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":null},{""$type"":""OpenFTTH.Events.RouteNetwork.RouteSegmentAdded, OpenFTTH.Events"",""segmentId"":""9990734c-38c4-4739-810a-ba5432492b25"",""fromNodeId"":""6be9abac-619a-42d4-8207-510a83d769cc"",""toNodeId"":""bafe3b26-dad1-43f9-8120-9c21c155bc43"",""geometry"":""[[557185.3754148477,6224206.351999512],[557186.0762978606,6224187.125002002]]"",""routeSegmentInfo"":{""kind"":""Underground"",""width"":null,""height"":null},""namingInfo"":null,""lifecyleInfo"":{""deploymentState"":""InService"",""installationDate"":null,""removalDate"":null},""mappingInfo"":{""method"":""Schematic"",""verticalAccuracy"":null,""horizontalAccuracy"":null,""surveyDate"":null,""sourceInfo"":null},""safetyInfo"":{""classification"":""Ikke farlig"",""remark"":null},""eventSequenceNumber"":0,""eventType"":""RouteSegmentAdded"",""eventId"":""943e7d78-8753-4db0-9a8a-d2c61f5b8f46"",""eventTimestamp"":""2020-10-28T10:44:43.5170385Z"",""applicationName"":"""",""applicationInfo"":""""}]}],""eventSequenceNumber"":4,""eventType"":""RouteNetworkEditOperationOccuredEvent"",""eventId"":""9662c420-76b3-42f4-b859-65a234e819e3"",""eventTimestamp"":""2020-10-28T10:44:43.5176681Z"",""applicationName"":""GDB_INTEGRATOR"",""applicationInfo"":""""}
            ]
        ")]
        public void CreateValidTerminalEquipment_ShouldEmitTerminalEquipmentPlacedEvent(string routeNetworkJson)
        {
            ILoggerFactory loggerFactory = new Microsoft.Extensions.Logging.Abstractions.NullLoggerFactory();

            var routeNodeMrid = Guid.Parse("6be9abac-619a-42d4-8207-510a83d769cc");

            var networkState = new InMemoryNetworkState(loggerFactory);
            networkState.SeedRouteNetworkEvents(routeNetworkJson);

            var queryApi = new InMemoryQueryHandler(loggerFactory, networkState);

            var node = new TerminalEquipmentAggregate(queryApi, routeNodeMrid, Guid.NewGuid(), Guid.NewGuid());

            Assert.Contains(node.GetUncommittedEvents(), o => o is TerminalEquipmentPlaced);
        }




    }
}
